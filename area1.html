<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guided Data Analysis — Healthy Cities (Exemplar) + Prompt Generator</title>

  <!-- Handsontable -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.6.0/dist/handsontable.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.6.0/dist/handsontable.min.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root { color-scheme: light; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header { padding: 14px 16px; border-bottom: 1px solid #e5e7eb; display:flex; gap:12px; align-items:center; }
    header h1 { font-size: 16px; margin: 0; font-weight: 750; }
    header .sub { color:#6b7280; font-size: 12px; }

    main { display:grid; grid-template-columns: 390px 1fr; height: calc(100vh - 56px); }
    aside { border-right:1px solid #e5e7eb; padding: 14px; overflow:auto; }
    section { padding: 14px; overflow:auto; }

    .card { border:1px solid #e5e7eb; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 0 rgba(0,0,0,.02); background:#fff; }
    .muted { color:#6b7280; font-size: 12px; line-height: 1.45; }
    .warn { background:#fff7ed; border:1px solid #fed7aa; padding: 10px; border-radius: 12px; color:#9a3412; font-size: 12px; }
    .ok { background:#f0fdf4; border:1px solid #bbf7d0; padding: 10px; border-radius: 12px; color:#166534; font-size: 12px; }

    .steps { display:flex; flex-direction:column; gap:8px; }
    .step { border:1px solid #e5e7eb; border-radius: 12px; padding: 10px; cursor:pointer; background:#fff; }
    .step.active { border-color:#111827; box-shadow: 0 0 0 2px rgba(17,24,39,.08); }
    .step .t { font-weight: 750; font-size: 13px; margin-bottom: 4px; }
    .step .d { color:#6b7280; font-size: 12px; line-height: 1.35; }

    .row { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    label { font-size: 12px; color:#374151; }
    select, button, input[type="text"], textarea {
      font: inherit; font-size: 12px;
      border:1px solid #d1d5db; border-radius: 10px; padding: 8px 10px; background:#fff;
    }
    textarea { width: 100%; min-height: 84px; resize: vertical; }
    button { cursor:pointer; }
    button.primary { background:#111827; color:white; border-color:#111827; }
    button:disabled { opacity:.5; cursor:not-allowed; }

    code.inline { background:#f3f4f6; padding: 2px 6px; border-radius: 8px; }

    .split { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }

    #sheetWrap { border:1px solid #e5e7eb; border-radius: 12px; overflow:hidden; height: 460px; }
    #sheet { height: 460px; }
    #chart { height: 360px; border:1px solid #e5e7eb; border-radius: 12px; }

    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .kpi > div { border:1px solid #e5e7eb; border-radius: 12px; padding: 10px; }
    .kpi .v { font-size: 18px; font-weight: 850; }
    .kpi .l { font-size: 11px; color:#6b7280; }

    #status { margin-top: 8px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #e5e7eb; border-radius: 999px; font-size: 11px; color:#374151; background:#fff; }

    .promptCard { border:1px dashed #d1d5db; border-radius: 12px; padding: 10px; background:#fafafa; }
    .promptHeader { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 8px; }
    .promptHeader .name { font-weight: 850; font-size: 12px; }
    .promptHeader .actions { display:flex; gap:8px; align-items:center; }
    .promptText { width: 100%; min-height: 130px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      aside{ border-right:none; border-bottom:1px solid #e5e7eb; }
      .split{ grid-template-columns: 1fr; }
      #sheetWrap, #sheet { height: 360px; }
      #chart{ height: 320px; }
    }
  </style>
</head>

<body>
<header>
  <h1>Guided Data Analysis — Healthy Cities Exemplar</h1>
  <div class="sub">Embedded “long table” + beginner analysis + generates AI prompts from your work</div>
</header>

<main>
  <aside>
    <div class="card">
      <div style="font-weight:850; font-size:13px;">Status</div>
      <div class="muted" id="status">loading…</div>
      <div class="muted" style="margin-top:8px;">
        <span class="pill" id="scopePill">Scope: All cities</span>
        <span class="pill" id="viewPill" style="margin-left:6px;">View: Long</span>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:850; font-size:13px; margin-bottom:8px;">Guided steps</div>
      <div class="steps" id="steps"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnPrev">← Prev</button>
        <button id="btnNext" class="primary">Next →</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:850; font-size:13px; margin-bottom:8px;">Controls</div>

      <div class="row" style="margin-bottom:8px;">
        <label>View</label>
        <select id="viewSelect">
          <option value="long">Long table (raw)</option>
          <option value="wide">Wide table (pivoted)</option>
        </select>
      </div>

      <div class="row" style="margin-bottom:8px;">
        <label>City</label>
        <select id="citySelect"></select>
      </div>

      <div class="row" style="margin-bottom:8px;">
        <label>Quick search</label>
        <input id="quickFilter" type="text" placeholder="search any field..." />
      </div>

      <div class="row">
        <button id="btnReset">Reset</button>
        <button id="btnPivot" class="primary">Build wide table</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:850; font-size:13px;">Mini experiment</div>
      <div class="muted" style="margin-top:6px;">
        After pivoting:
        <br/>• <b>TobaccoAvailability</b> vs <b>AsthmaExpenditure_mean</b>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btnRunExp" disabled>Run correlation</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900; font-size:13px;">Your project specification</div>
      <div class="muted" style="margin-top:6px;">
        As you work through the steps, write what project you want to build. The app will turn this into AI prompts.
      </div>

      <div class="row" style="margin-top:10px;">
        <label style="width:100%;">Project goal (1–2 sentences)</label>
        <textarea id="specGoal" placeholder="Example: Build an interactive dashboard that helps city planners explore links between built environment and health outcomes at MSOA level."></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <label style="width:100%;">Users & decisions</label>
        <textarea id="specUsers" placeholder="Who uses it (e.g., public health teams)? What decisions will it support?"></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <label style="width:100%;">Inputs & outputs</label>
        <textarea id="specIO" placeholder="Inputs (datasets/filters), outputs (charts, maps, reports), and constraints (privacy, accessibility)."></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <label style="width:100%;">Success criteria</label>
        <textarea id="specSuccess" placeholder="Example: a novice can run a pivot + correlation and understand limitations within 10 minutes."></textarea>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnGeneratePrompts" class="primary">Generate AI prompts</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Tip: changing City/View and running the experiment updates the prompts with context.
      </div>
    </div>
  </aside>

  <section>
    <div class="card">
      <div id="stepTitle" style="font-weight:900; font-size:14px;"></div>
      <div id="stepBody" class="muted" style="margin-top:6px;"></div>
      <div id="stepBox" style="margin-top:10px;"></div>
    </div>

    <div class="split">
      <div class="card">
        <div style="font-weight:900; font-size:13px;">Spreadsheet</div>
        <div class="muted" id="gridCaption" style="margin-top:6px;">Long table view (raw measurements).</div>

        <div id="sheetWrap" style="margin-top:10px;">
          <div id="sheet"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="font-weight:900; font-size:13px;">Chart / results</div>
          <div class="muted" id="chartCaption" style="margin-top:6px;">Charts appear when relevant.</div>
          <div id="chart" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <div style="font-weight:900; font-size:13px; margin-bottom:8px;">Quick checks</div>
          <div class="kpi">
            <div><div class="v" id="kpiRows">—</div><div class="l">Rows shown</div></div>
            <div><div class="v" id="kpiGroups">—</div><div class="l">Distinct MSOAs</div></div>
          </div>
          <div class="muted" style="margin-top:8px;" id="kpiNote">—</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900; font-size:13px;">Generated generative-AI prompts</div>
      <div class="muted" style="margin-top:6px;">
        These prompts are built from your specification + your interactions (scope, pivot choice, experiment results).
        Copy/paste them into your AI tool of choice.
      </div>

      <div style="margin-top:10px; display:grid; gap:10px;">
        <div class="promptCard">
          <div class="promptHeader">
            <div class="name">Prompt A — Spec refinement recommendations</div>
            <div class="actions">
              <button data-copy="promptRefine">Copy</button>
            </div>
          </div>
          <textarea class="promptText" id="promptRefine" readonly></textarea>
        </div>

        <div class="promptCard">
          <div class="promptHeader">
            <div class="name">Prompt B — Diagram of the project and its impacts</div>
            <div class="actions">
              <button data-copy="promptDiagram">Copy</button>
            </div>
          </div>
          <textarea class="promptText" id="promptDiagram" readonly></textarea>
        </div>

        <div class="promptCard">
          <div class="promptHeader">
            <div class="name">Prompt C — Generate an interactive HTML/JS program illustrating the project</div>
            <div class="actions">
              <button data-copy="promptBuild">Copy</button>
            </div>
          </div>
          <textarea class="promptText" id="promptBuild" readonly></textarea>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/* ========== error visibility ========== */
window.addEventListener("error", (e) => {
  const s = document.getElementById("status");
  if (s) s.textContent = "JS error — " + (e?.message || "unknown");
});

/* ========== data ========== */
const EXEMPLAR_LONG = [
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"None",   Key:"value",     Value:"0.38"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"None",   Key:"value",     Value:"72"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"2023-01", Key:"£/citizen", Value:"21.0"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"2023-02", Key:"£/citizen", Value:"23.4"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"2023-03", Key:"£/citizen", Value:"22.2"},

  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"None",   Key:"value",     Value:"0.22"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"None",   Key:"value",     Value:"64"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"2023-01", Key:"£/citizen", Value:"16.4"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"2023-02", Key:"£/citizen", Value:"15.8"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"2023-03", Key:"£/citizen", Value:"17.1"},

  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"None",   Key:"value",     Value:"0.44"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"None",   Key:"value",     Value:"51"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"2023-01", Key:"£/citizen", Value:"27.5"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"2023-02", Key:"£/citizen", Value:"26.9"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"2023-03", Key:"£/citizen", Value:"28.1"},

  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"None",   Key:"value",     Value:"0.18"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"None",   Key:"value",     Value:"78"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"2023-01", Key:"£/citizen", Value:"14.2"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"2023-02", Key:"£/citizen", Value:"13.7"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"2023-03", Key:"£/citizen", Value:"14.9"},
];

const el = (id) => document.getElementById(id);
const state = {
  longRows: JSON.parse(JSON.stringify(EXEMPLAR_LONG)),
  wideRows: null,
  view: "long",
  stepIndex: 0,
  hot: null,
  lastExperiment: null, // {r,n,city,points}
};

/* ========== teaching steps ========== */
const steps = [
  { title:"1) Start with a question", desc:"Define what you want to learn.", render(){
      setStep("Start with a question",
        `Begin with a question, not a chart. Example: “Do areas with more tobacco outlets have higher asthma costs?”
         <br/><br/>Find <code class="inline">ThirdCategory</code>, <code class="inline">Time</code>, <code class="inline">Value</code>. What does one row represent?`,
        warnBox(`Try searching “AsthmaExpenditure”.`)
      );
      showLong();
  }},
  { title:"2) Understand the long table", desc:"One row = one measurement.", render(){
      setStep("Understand the long table",
        `Each row answers: what / where / when / value. Time “None” means not a time series in this exemplar.`,
        okBox(`Search “None” and see which indicators are single values.`)
      );
      showLong();
  }},
  { title:"3) Choose scope", desc:"All cities or one city?", render(){
      setStep("Choose your scope",
        `Scope changes results. Choose a city (or all cities) before you analyse. Write it down in your spec.`,
        warnBox(`Switch the City dropdown and watch the table update.`)
      );
      showLong();
  }},
  { title:"4) Pivot (wide table)", desc:"Make one row per MSOA.", render(){
      setStep("Pivot to a wide table",
        `To compare variables side-by-side, pivot long→wide. Here we compute Asthma mean over months per MSOA.`,
        okBox(`Click “Build wide table”, then switch View to “Wide table”.`)
      );
      showLong();
  }},
  { title:"5) Run experiment", desc:"Scatter + Pearson r.", render(){
      setStep("Experiment: Tobacco vs Asthma",
        `We’ll plot one dot per MSOA and compute Pearson r (association, not causation).`,
        warnBox(`Build the wide table first, then click “Run correlation”.`)
      );
      showWideIfReady();
  }},
  { title:"6) Generate AI prompts", desc:"Turn your work into prompts.", render(){
      setStep("Generate AI prompts",
        `Now you’ll generate three prompts:
         <ol>
           <li>Ask an AI to <b>refine</b> your project spec.</li>
           <li>Ask an AI for a <b>diagram</b> of the project + impacts.</li>
           <li>Ask an AI to build an <b>interactive HTML/JS demo</b> illustrating the project.</li>
         </ol>
         Fill in the project specification panel (left) and click <b>Generate AI prompts</b>.`,
        okBox(`Tip: run the experiment first so the prompts include analysis context.`)
      );
  }},
];

function setStep(title, bodyHtml, boxHtml) {
  el("stepTitle").textContent = title;
  el("stepBody").innerHTML = bodyHtml;
  el("stepBox").innerHTML = boxHtml || "";
}
function warnBox(html){ return `<div class="warn"><b>Try this:</b> ${html}</div>`; }
function okBox(html){ return `<div class="ok"><b>Good to know:</b> ${html}</div>`; }

/* ========== helpers ========== */
function toNum(x) {
  const n = Number(String(x ?? "").trim());
  return Number.isFinite(n) ? n : NaN;
}
function mean(arr) {
  let s=0,c=0;
  for (const v of arr) if (Number.isFinite(v)) { s += v; c++; }
  return c ? s/c : NaN;
}
function pearson(xs, ys) {
  const pts = [];
  for (let i=0;i<xs.length;i++){
    const x=xs[i], y=ys[i];
    if (Number.isFinite(x) && Number.isFinite(y)) pts.push([x,y]);
  }
  const n = pts.length;
  if (n < 3) return { r: NaN, n };

  let sx=0, sy=0;
  for (const [x,y] of pts){ sx+=x; sy+=y; }
  const mx = sx/n, my = sy/n;

  let num=0, dx=0, dy=0;
  for (const [x,y] of pts){
    const vx=x-mx, vy=y-my;
    num += vx*vy;
    dx += vx*vx;
    dy += vy*vy;
  }
  const den = Math.sqrt(dx*dy);
  return { r: den ? num/den : NaN, n };
}

function applyFilters(rows) {
  const city = el("citySelect").value;
  const q = el("quickFilter").value.trim().toLowerCase();

  let out = rows;
  if (city !== "All cities") out = out.filter(r => r.CityName === city);
  if (q) out = out.filter(r => Object.values(r).some(v => String(v ?? "").toLowerCase().includes(q)));
  return out;
}

/* ========== pivot ========== */
function buildWideTableFromLong(longRowsFiltered) {
  const byMSOA = new Map();

  function ensure(r) {
    if (!byMSOA.has(r.MSOACode)) byMSOA.set(r.MSOACode, {
      CityName: r.CityName,
      MSOAName: r.MSOAName,
      MSOACode: r.MSOACode,
      TobaccoAvailability: NaN,
      Walkability: NaN,
      AsthmaExpenditure_mean: NaN,
      Asthma_nMonths: 0,
      _asthma: [],
    });
    return byMSOA.get(r.MSOACode);
  }

  for (const r of longRowsFiltered) {
    if (!r.MSOACode) continue;
    const row = ensure(r);

    if (r.ThirdCategory === "TobaccoAvailability" && r.Time === "None") {
      const v = toNum(r.Value);
      if (Number.isFinite(v)) row.TobaccoAvailability = v;
    }
    if (r.ThirdCategory === "Walkability" && r.Time === "None") {
      const v = toNum(r.Value);
      if (Number.isFinite(v)) row.Walkability = v;
    }
    if (r.ThirdCategory === "AsthmaExpenditure") {
      const v = toNum(r.Value);
      if (Number.isFinite(v)) row._asthma.push(v);
    }
  }

  const out = [];
  for (const row of byMSOA.values()) {
    row.Asthma_nMonths = row._asthma.length;
    row.AsthmaExpenditure_mean = mean(row._asthma);
    delete row._asthma;
    out.push(row);
  }
  out.sort((a,b) => a.CityName.localeCompare(b.CityName) || a.MSOAName.localeCompare(b.MSOAName));
  return out;
}

/* ========== handsontable ========== */
function ensureHot() {
  if (state.hot) return;
  const container = el("sheet");
  state.hot = new Handsontable(container, {
    data: [[]],
    colHeaders: [],
    rowHeaders: true,
    readOnly: true,
    height: 460,
    width: "100%",
    stretchH: "all",
    manualColumnResize: true,
    filters: true,
    dropdownMenu: true,
    columnSorting: true,
    licenseKey: "non-commercial-and-evaluation",
  });
}

function setSheet(rows, columnsOrder) {
  ensureHot();
  const dataMatrix = rows.map(r => columnsOrder.map(c => r[c]));
  state.hot.loadData(dataMatrix);
  state.hot.updateSettings({ colHeaders: columnsOrder });
  state.hot.render();
  updateKPIs(rows);
}

function updateKPIs(rows) {
  el("kpiRows").textContent = rows.length.toLocaleString();
  const ms = new Set(rows.map(r => r.MSOACode).filter(Boolean));
  el("kpiGroups").textContent = ms.size ? ms.size.toLocaleString() : "—";

  if (state.view === "long") {
    const noneTime = rows.filter(r => String(r.Time).toLowerCase() === "none").length;
    el("kpiNote").textContent = `Long table check: rows with Time=None: ${noneTime.toLocaleString()}.`;
  } else {
    const missing = rows.filter(r =>
      !Number.isFinite(toNum(r.TobaccoAvailability)) || !Number.isFinite(toNum(r.AsthmaExpenditure_mean))
    ).length;
    el("kpiNote").textContent = `Wide table check: rows missing x or y: ${missing.toLocaleString()}.`;
  }
}

function clearChart(msg) {
  Plotly.purge("chart");
  Plotly.newPlot("chart", [], { margin: {t: 20, r: 10, b: 40, l: 50} }, {displaylogo:false, responsive:true});
  el("chartCaption").textContent = msg;
}

/* ========== views ========== */
const LONG_COLS = ["TopCategory","SecondCategory","ThirdCategory","CityName","MSOAName","MSOACode","Time","Key","Value"];
const WIDE_COLS = ["CityName","MSOAName","MSOACode","TobaccoAvailability","Walkability","AsthmaExpenditure_mean","Asthma_nMonths"];

function updatePills() {
  const city = el("citySelect").value;
  el("scopePill").textContent = `Scope: ${city}`;
  el("viewPill").textContent = `View: ${state.view === "long" ? "Long" : "Wide"}`;
}

function showLong() {
  state.view = "long";
  el("viewSelect").value = "long";
  el("gridCaption").textContent = "Long table view (raw measurements).";
  el("btnRunExp").disabled = true;

  const rows = applyFilters(state.longRows);
  setSheet(rows, LONG_COLS);
  clearChart("In long-table view. Build the wide table to run the experiment.");
  updatePills();
  autoRefreshPrompts();
}

function showWideIfReady() {
  if (!state.wideRows) {
    clearChart("Build the wide table first (click “Build wide table”).");
    updatePills();
    autoRefreshPrompts();
    return;
  }
  showWide();
}

function showWide() {
  state.view = "wide";
  el("viewSelect").value = "wide";
  el("gridCaption").textContent = "Wide table view (pivoted, analysis-ready).";
  el("btnRunExp").disabled = false;

  const rows = applyFilters(state.wideRows);
  setSheet(rows, WIDE_COLS);
  clearChart("Wide table ready. Click “Run correlation” to create a chart.");
  updatePills();
  autoRefreshPrompts();
}

/* ========== experiment ========== */
function runCorrelation() {
  if (!state.wideRows) return;

  const rows = applyFilters(state.wideRows);
  const xs = [], ys = [], labels = [];

  for (const r of rows) {
    const x = toNum(r.TobaccoAvailability);
    const y = toNum(r.AsthmaExpenditure_mean);
    if (Number.isFinite(x) && Number.isFinite(y)) {
      xs.push(x); ys.push(y);
      labels.push(`${r.CityName} — ${r.MSOAName} (${r.MSOACode})`);
    }
  }

  const { r, n } = pearson(xs, ys);
  state.lastExperiment = {
    r, n,
    city: el("citySelect").value,
    points: xs.length
  };

  const trace = {
    type: "scatter",
    mode: "markers",
    x: xs,
    y: ys,
    text: labels,
    hovertemplate: "%{text}<br><b>Tobacco</b>=%{x}<br><b>Asthma mean</b>=%{y}<extra></extra>",
    marker: { size: 9, opacity: 0.8 },
  };

  const layout = {
    title: {
      text: `Tobacco availability vs Asthma expenditure<br><span style="font-size:12px;color:#6b7280">Pearson r = ${Number.isFinite(r) ? r.toFixed(3) : "NA"} (n=${n})</span>`,
      x: 0, xanchor: "left"
    },
    margin: { t: 60, r: 10, b: 55, l: 70 },
    xaxis: { title: "TobaccoAvailability (example scale)", zeroline: false },
    yaxis: { title: "AsthmaExpenditure_mean (example £/citizen)", zeroline: false },
  };

  Plotly.react("chart", [trace], layout, { responsive:true, displaylogo:false });
  el("chartCaption").textContent =
    `One dot per MSOA. Pearson r summarizes association (not causation). r=${Number.isFinite(r) ? r.toFixed(3) : "NA"}, n=${n}.`;

  autoRefreshPrompts();
}

/* ========== prompt generation ========== */
function getSpec() {
  return {
    goal: el("specGoal").value.trim(),
    users: el("specUsers").value.trim(),
    io: el("specIO").value.trim(),
    success: el("specSuccess").value.trim(),
  };
}

function getInteractionContext() {
  const scope = el("citySelect").value;
  const view = state.view;
  const didPivot = !!state.wideRows;
  const exp = state.lastExperiment;

  const search = el("quickFilter").value.trim();

  return {
    scope,
    view,
    didPivot,
    quickSearch: search || "(none)",
    exemplarDatasetNotes: [
      "Data stored as long table with fields: TopCategory, SecondCategory, ThirdCategory, CityName, MSOAName, MSOACode, Time, Key, Value.",
      "Some indicators are not time series (Time=None).",
      "Pivot step creates wide table: one row per MSOA with indicator columns; Asthma expenditure aggregated as mean across months."
    ],
    experiment: exp ? {
      ran: true,
      city: exp.city,
      points: exp.points,
      pearsonR: Number.isFinite(exp.r) ? exp.r : null,
      n: exp.n
    } : { ran: false }
  };
}

function buildPrompts() {
  const spec = getSpec();
  const ctx = getInteractionContext();

  const specBlock = [
    `PROJECT SPECIFICATION (draft)`,
    `Goal: ${spec.goal || "(not provided)"}`,
    `Users & decisions: ${spec.users || "(not provided)"}`,
    `Inputs & outputs: ${spec.io || "(not provided)"}`,
    `Success criteria: ${spec.success || "(not provided)"}`
  ].join("\n");

  const ctxBlock = [
    `CONTEXT FROM THE PROTOTYPE APP (user interactions)`,
    `Scope (city selection): ${ctx.scope}`,
    `Current view: ${ctx.view}`,
    `Wide-table pivot built: ${ctx.didPivot ? "yes" : "no"}`,
    `Quick search term used: ${ctx.quickSearch}`,
    `Experiment run: ${ctx.experiment.ran ? "yes" : "no"}`,
    ctx.experiment.ran
      ? `Experiment details: points=${ctx.experiment.points}, n=${ctx.experiment.n}, Pearson r=${ctx.experiment.pearsonR ?? "NA"} (tobacco availability vs asthma expenditure mean)`
      : `Experiment details: (not run yet)`,
    ``,
    `Dataset notes:`,
    ...ctx.exemplarDatasetNotes.map(x => `- ${x}`)
  ].join("\n");

  // Prompt A: spec refinement recommendations
  const promptRefine =
`You are an expert product manager and data-science lead.

${specBlock}

${ctxBlock}

TASK:
1) Suggest refinements and missing details in the specification so it is implementation-ready.
2) Identify ambiguities and ask the minimum set of clarifying questions (grouped by: data, users, UX, evaluation, privacy/ethics).
3) Recommend a phased plan (MVP → v1 → v2) with acceptance criteria for each phase.
4) Include risks (data quality, bias, misinterpretation, confounding) and how to mitigate them.
5) Output your answer as:
   - "Refinements"
   - "Clarifying questions"
   - "Phased plan"
   - "Risks & mitigations"
`;

  // Prompt B: diagram of project + impacts (text-based diagram)
  const promptDiagram =
`You are a systems thinker and technical communicator.

${specBlock}

${ctxBlock}

TASK:
Create a clear diagram of the project and its impacts.
- Provide TWO versions:
  (A) a Mermaid diagram (flowchart or system diagram),
  (B) a simple ASCII diagram.
- Your diagram must include:
  - Actors/users
  - Data sources & preprocessing (long→wide pivot, aggregation decisions)
  - Analysis modules (filters, summary stats, correlation/experiments)
  - UI/interaction steps (guided learning)
  - Outputs (charts, tables, reports)
  - Impact pathways (how it changes decisions and outcomes)
  - Risks/guardrails (misinterpretation, bias, privacy)
- Then add a short paragraph explaining the diagram in plain language.
`;

  // Prompt C: ask AI to generate an interactive HTML/JS program illustrating the project
  const promptBuild =
`You are a senior frontend engineer and data-visualization developer.

${specBlock}

${ctxBlock}

TASK:
Generate a single-file HTML + JavaScript program (no build step) that interactively illustrates the function of this project.
Requirements:
- Must be beginner-friendly and guide the user step-by-step (teach what/why).
- Include a spreadsheet-like grid for data (use a robust library like Handsontable OR implement a simple table if no CDN).
- Use an embedded exemplar dataset matching the described schema (long table; include some Time=None and some time series).
- Implement:
  1) Long-table view + filtering (city, search)
  2) Pivot/aggregation to a wide table (one row per MSOA; choose mean across months for one metric)
  3) At least one simple “experiment” (scatter + correlation) with warnings about correlation≠causation
  4) A "Generate prompts" panel that produces prompts similar to: refinement, diagram, and app generator prompts
- Must run by opening the HTML file directly.
- Keep styling clean and minimal. Include comments explaining key parts of the code.
Output ONLY the complete HTML file.
`;

  return { promptRefine, promptDiagram, promptBuild };
}

function setPrompts(prompts) {
  el("promptRefine").value = prompts.promptRefine;
  el("promptDiagram").value = prompts.promptDiagram;
  el("promptBuild").value = prompts.promptBuild;
}

function autoRefreshPrompts() {
  // lightweight auto-refresh: only if any prompt already exists OR if user filled any spec fields
  const spec = getSpec();
  const haveSpec = (spec.goal || spec.users || spec.io || spec.success);
  const already = (el("promptRefine").value || el("promptDiagram").value || el("promptBuild").value);
  if (!haveSpec && !already) return;

  setPrompts(buildPrompts());
}

async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand("copy"); } catch {}
    document.body.removeChild(ta);
    return true;
  }
}

/* ========== steps UI ========== */
function renderSteps() {
  const wrap = el("steps");
  wrap.innerHTML = "";
  steps.forEach((s, i) => {
    const d = document.createElement("div");
    d.className = "step" + (i === state.stepIndex ? " active" : "");
    d.innerHTML = `<div class="t">${s.title}</div><div class="d">${s.desc}</div>`;
    d.onclick = () => { state.stepIndex = i; refreshStep(); };
    wrap.appendChild(d);
  });
}
function refreshStep() {
  renderSteps();
  steps[state.stepIndex].render();
  el("btnPrev").disabled = state.stepIndex === 0;
  el("btnNext").disabled = state.stepIndex === steps.length - 1;
}

/* ========== boot ========== */
window.addEventListener("DOMContentLoaded", () => {
  const status = el("status");

  if (!window.Handsontable) {
    status.textContent = "Handsontable failed to load (check CDN/network access).";
    status.className = "warn";
    return;
  }

  // Populate cities
  const cities = ["All cities", ...Array.from(new Set(state.longRows.map(r => r.CityName))).sort()];
  const cs = el("citySelect");
  cities.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c;
    cs.appendChild(opt);
  });
  cs.value = "All cities";

  clearChart("Follow the steps; charts appear when relevant.");
  ensureHot();

  // Initial view
  showLong();
  refreshStep();
  status.textContent = "Ready (exemplar data loaded).";
  updatePills();

  // UI wiring
  el("quickFilter").addEventListener("input", () => (state.view === "long" ? showLong() : showWideIfReady()));
  el("citySelect").addEventListener("change", () => (state.view === "long" ? showLong() : showWideIfReady()));
  el("viewSelect").addEventListener("change", () => (el("viewSelect").value === "long" ? showLong() : showWideIfReady()));

  el("btnReset").onclick = () => {
    el("quickFilter").value = "";
    cs.value = "All cities";
    state.lastExperiment = null;
    if (state.view === "long") showLong(); else showWideIfReady();
  };

  el("btnPivot").onclick = () => {
    const longFiltered = applyFilters(state.longRows); // scope matters
    state.wideRows = buildWideTableFromLong(longFiltered);
    el("btnRunExp").disabled = false;
    showWideIfReady();
  };

  el("btnRunExp").onclick = () => runCorrelation();

  el("btnPrev").onclick = () => { state.stepIndex = Math.max(0, state.stepIndex - 1); refreshStep(); };
  el("btnNext").onclick = () => { state.stepIndex = Math.min(steps.length - 1, state.stepIndex + 1); refreshStep(); };

  // Spec fields auto-refresh prompts
  ["specGoal","specUsers","specIO","specSuccess"].forEach(id => {
    el(id).addEventListener("input", () => autoRefreshPrompts());
  });

  el("btnGeneratePrompts").onclick = () => {
    setPrompts(buildPrompts());
    // jump user to last step if they want
    // state.stepIndex = steps.length - 1; refreshStep();
  };

  // Copy buttons
  document.querySelectorAll("button[data-copy]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const targetId = btn.getAttribute("data-copy");
      const text = el(targetId).value || "";
      if (!text.trim()) return;
      btn.textContent = "Copied!";
      await copyToClipboard(text);
      setTimeout(()=>btn.textContent="Copy", 900);
    });
  });

  // Initialize prompts with a template so user sees what they are
  setPrompts(buildPrompts());
});

/* ========== chart helper ========== */
function clearChart(msg) {
  Plotly.purge("chart");
  Plotly.newPlot("chart", [], { margin: {t: 20, r: 10, b: 40, l: 50} }, {displaylogo:false, responsive:true});
  el("chartCaption").textContent = msg;
}
</script>
</body>
</html>
