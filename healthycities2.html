<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guided Data Analysis — Healthy Cities (Exemplar)</title>

  <!-- Handsontable (spreadsheet-like grid) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.6.0/dist/handsontable.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.6.0/dist/handsontable.min.js"></script>

  <!-- Plotly for simple charts -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root { color-scheme: light; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header { padding: 14px 16px; border-bottom: 1px solid #e5e7eb; display:flex; gap:12px; align-items:center; }
    header h1 { font-size: 16px; margin: 0; font-weight: 750; }
    header .sub { color:#6b7280; font-size: 12px; }

    main { display:grid; grid-template-columns: 390px 1fr; height: calc(100vh - 56px); }
    aside { border-right:1px solid #e5e7eb; padding: 14px; overflow:auto; }
    section { padding: 14px; overflow:auto; }

    .card { border:1px solid #e5e7eb; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 0 rgba(0,0,0,.02); background:#fff; }
    .muted { color:#6b7280; font-size: 12px; line-height: 1.45; }
    .warn { background:#fff7ed; border:1px solid #fed7aa; padding: 10px; border-radius: 12px; color:#9a3412; font-size: 12px; }
    .ok { background:#f0fdf4; border:1px solid #bbf7d0; padding: 10px; border-radius: 12px; color:#166534; font-size: 12px; }

    .steps { display:flex; flex-direction:column; gap:8px; }
    .step { border:1px solid #e5e7eb; border-radius: 12px; padding: 10px; cursor:pointer; background:#fff; }
    .step.active { border-color:#111827; box-shadow: 0 0 0 2px rgba(17,24,39,.08); }
    .step .t { font-weight: 750; font-size: 13px; margin-bottom: 4px; }
    .step .d { color:#6b7280; font-size: 12px; line-height: 1.35; }

    .row { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    label { font-size: 12px; color:#374151; }
    select, button, input[type="text"] {
      font: inherit; font-size: 12px;
      border:1px solid #d1d5db; border-radius: 10px; padding: 8px 10px; background:#fff;
    }
    button { cursor:pointer; }
    button.primary { background:#111827; color:white; border-color:#111827; }
    button:disabled { opacity:.5; cursor:not-allowed; }

    code.inline { background:#f3f4f6; padding: 2px 6px; border-radius: 8px; }

    .split { display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }

    #sheetWrap { border:1px solid #e5e7eb; border-radius: 12px; overflow:hidden; height: 460px; }
    #sheet { height: 460px; }
    #chart { height: 360px; border:1px solid #e5e7eb; border-radius: 12px; }

    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .kpi > div { border:1px solid #e5e7eb; border-radius: 12px; padding: 10px; }
    .kpi .v { font-size: 18px; font-weight: 850; }
    .kpi .l { font-size: 11px; color:#6b7280; }

    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      aside{ border-right:none; border-bottom:1px solid #e5e7eb; }
      .split{ grid-template-columns: 1fr; }
      #sheetWrap, #sheet { height: 360px; }
      #chart{ height: 320px; }
    }
  </style>
</head>

<body>
<header>
  <h1>Guided Data Analysis — Healthy Cities Exemplar</h1>
  <div class="sub">Embedded “long table” + beginner step-by-step analysis (Handsontable grid)</div>
</header>

<main>
  <aside>
    <div class="card">
      <div style="font-weight:850; font-size:13px;">What you’re looking at</div>
      <div class="muted" style="margin-top:8px;">
        This app uses a <b>small example dataset</b> that mimics real city datasets:
        stored as a <b>long table</b>, where each row is one measurement.
        <br/><br/>
        You’ll learn <b>what to do</b>, <b>why</b>, and <b>what questions to ask</b>—from scratch.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:850; font-size:13px; margin-bottom:8px;">Guided steps</div>
      <div class="steps" id="steps"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnPrev">← Prev</button>
        <button id="btnNext" class="primary">Next →</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:850; font-size:13px; margin-bottom:8px;">Controls</div>

      <div class="row" style="margin-bottom:8px;">
        <label>View</label>
        <select id="viewSelect">
          <option value="long">Long table (raw)</option>
          <option value="wide">Wide table (pivoted)</option>
        </select>
      </div>

      <div class="row" style="margin-bottom:8px;">
        <label>City</label>
        <select id="citySelect"></select>
      </div>

      <div class="row" style="margin-bottom:8px;">
        <label>Quick search</label>
        <input id="quickFilter" type="text" placeholder="search any field..." />
      </div>

      <div class="row">
        <button id="btnReset">Reset</button>
        <button id="btnPivot" class="primary">Build wide table</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        Tip: This is a teaching dataset. In real work, you’d load a CSV—but the analysis steps are the same.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:850; font-size:13px;">Mini experiment</div>
      <div class="muted" style="margin-top:6px;">
        After pivoting, we’ll run:
        <br/>• <b>TobaccoAvailability</b> vs <b>AsthmaExpenditure_mean</b>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btnRunExp" disabled>Run correlation</button>
      </div>
    </div>
  </aside>

  <section>
    <div class="card">
      <div id="stepTitle" style="font-weight:900; font-size:14px;"></div>
      <div id="stepBody" class="muted" style="margin-top:6px;"></div>
      <div id="stepBox" style="margin-top:10px;"></div>
    </div>

    <div class="split">
      <div class="card">
        <div style="font-weight:900; font-size:13px;">Spreadsheet</div>
        <div class="muted" id="gridCaption" style="margin-top:6px;">Long table view (raw measurements).</div>
        <div id="sheetWrap" style="margin-top:10px;">
          <div id="sheet"></div>
        </div>
        <div class="muted" style="margin-top:8px;">
          You can click headers to sort. Use the search box to filter the dataset shown.
        </div>
      </div>

      <div>
        <div class="card">
          <div style="font-weight:900; font-size:13px;">Chart / results</div>
          <div class="muted" id="chartCaption" style="margin-top:6px;">Charts appear when relevant.</div>
          <div id="chart" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <div style="font-weight:900; font-size:13px; margin-bottom:8px;">Quick checks</div>
          <div class="kpi">
            <div><div class="v" id="kpiRows">—</div><div class="l">Rows shown</div></div>
            <div><div class="v" id="kpiGroups">—</div><div class="l">Distinct MSOAs</div></div>
          </div>
          <div class="muted" style="margin-top:8px;" id="kpiNote">—</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900; font-size:13px;">Cheat sheet: what “pivot” means</div>
      <div class="muted" style="margin-top:8px;">
        <b>Long table:</b> many rows per area because each metric/time is a separate row.<br/>
        <b>Wide table:</b> one row per area, with metrics as separate columns (easier for correlation/regression).
      </div>
    </div>
  </section>
</main>

<script>
/* ============================
   Embedded exemplar dataset
   ============================ */
const EXEMPLAR_LONG = [
  // Riverside
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"None",   Key:"value",     Value:"0.38"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"None",   Key:"value",     Value:"72"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"2023-01", Key:"£/citizen", Value:"21.0"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"2023-02", Key:"£/citizen", Value:"23.4"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV01", MSOAName:"Riverside Central", Time:"2023-03", Key:"£/citizen", Value:"22.2"},

  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"None",   Key:"value",     Value:"0.22"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"None",   Key:"value",     Value:"64"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"2023-01", Key:"£/citizen", Value:"16.4"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"2023-02", Key:"£/citizen", Value:"15.8"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Riverside", MSOACode:"RV02", MSOAName:"Riverside North",   Time:"2023-03", Key:"£/citizen", Value:"17.1"},

  // Hillford
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"None",   Key:"value",     Value:"0.44"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"None",   Key:"value",     Value:"51"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"2023-01", Key:"£/citizen", Value:"27.5"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"2023-02", Key:"£/citizen", Value:"26.9"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF01", MSOAName:"Hillford East", Time:"2023-03", Key:"£/citizen", Value:"28.1"},

  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"TobaccoAvailability", CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"None",   Key:"value",     Value:"0.18"},
  {TopCategory:"EnvironmentalDeterminants", SecondCategory:"BuiltEnvironment", ThirdCategory:"Walkability",        CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"None",   Key:"value",     Value:"78"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"2023-01", Key:"£/citizen", Value:"14.2"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"2023-02", Key:"£/citizen", Value:"13.7"},
  {TopCategory:"HealthOutcome",             SecondCategory:"PhysicalHealth",   ThirdCategory:"AsthmaExpenditure",  CityName:"Hillford", MSOACode:"HF02", MSOAName:"Hillford West", Time:"2023-03", Key:"£/citizen", Value:"14.9"},
];

const el = (id) => document.getElementById(id);

const state = {
  longRows: structuredClone(EXEMPLAR_LONG),
  wideRows: null,
  view: "long",
  stepIndex: 0,
  hot: null,
  currentRows: [],
  currentColumns: [],
};

/* ============================
   Teaching steps
   ============================ */
const steps = [
  {
    title: "1) Start with a question",
    desc: "Define what you want to learn before touching the data.",
    render() {
      setStep(
        "Start with a question (this drives everything)",
        `
        Data analysis begins with a question, not a chart.
        <br/><br/>
        <b>Example question:</b> “Do areas with more tobacco outlets have higher asthma costs?”
        <br/><br/>
        <b>What to ask next:</b>
        <ul>
          <li>What are my variables (x and y)?</li>
          <li>What is my “unit” (MSOA, city, month)?</li>
          <li>Do I need to aggregate over time?</li>
        </ul>
        `,
        warnBox(`In the grid, find <code class="inline">ThirdCategory</code>, <code class="inline">Time</code>, and <code class="inline">Value</code>. Ask: “What does one row represent?”`)
      );
      showLong();
    }
  },
  {
    title: "2) Understand what a row means",
    desc: "Long table: one row = one measurement.",
    render() {
      setStep(
        "Understand the long table (raw format)",
        `
        In a long table, each row is one measurement:
        <b>what / where / when / value</b>.
        <ul>
          <li><b>CityName + MSOACode</b> = where</li>
          <li><b>ThirdCategory</b> = what indicator (e.g., TobaccoAvailability)</li>
          <li><b>Time</b> = when (or “None” if not a time series)</li>
          <li><b>Value</b> = the number to analyse</li>
        </ul>
        <b>Question to ask:</b> “Which indicators are time series and which are single values?”
        `,
        okBox(`Search for <code class="inline">Time</code> = “None”. Those indicators don’t vary over time in this exemplar.`)
      );
      showLong();
    }
  },
  {
    title: "3) Sanity checks",
    desc: "Check missing values, duplicates, and units.",
    render() {
      setStep(
        "Sanity checks (how you avoid wrong conclusions)",
        `
        Before analysis, quickly check:
        <ol>
          <li><b>Missing values:</b> are any Values blank/non-numeric?</li>
          <li><b>Duplicates:</b> same MSOA + indicator + time repeated?</li>
          <li><b>Units:</b> what does <code class="inline">Key</code> mean?</li>
        </ol>
        <b>Why:</b> if you mix units or double-count rows, your results can be wrong.
        `,
        warnBox(`Try searching “£/citizen”. Ask: “Which indicators are costs/expenditures?”`)
      );
      showLong();
    }
  },
  {
    title: "4) Choose scope",
    desc: "Decide what subset you are analysing (city, time).",
    render() {
      setStep(
        "Choose your scope (what are you comparing?)",
        `
        Scope decisions change results:
        <ul>
          <li>One city vs all cities</li>
          <li>Which months/years?</li>
          <li>Which indicators?</li>
        </ul>
        <b>Why:</b> If you don’t state scope, your analysis can’t be reproduced.
        `,
        warnBox(`Use the City dropdown. Ask: “Am I comparing areas within one city, or mixing cities?”`)
      );
      showLong();
    }
  },
  {
    title: "5) Pivot to a wide table",
    desc: "Put variables side-by-side per MSOA.",
    render() {
      setStep(
        "Pivot: long → wide (analysis-ready)",
        `
        For correlation/regression, it’s easier if each MSOA is one row and indicators are columns.
        <br/><br/>
        This app’s wide table includes:
        <ul>
          <li><b>TobaccoAvailability</b> (single value)</li>
          <li><b>Walkability</b> (single value)</li>
          <li><b>AsthmaExpenditure_mean</b> (mean across months)</li>
        </ul>
        <b>Key question:</b> “How should I reduce time-series values?” (mean? last month? trend?)
        `,
        okBox(`Click <b>Build wide table</b>, then switch View to “Wide table (pivoted)”.`)
      );
      showLong();
    }
  },
  {
    title: "6) Run a simple experiment",
    desc: "Scatter plot + correlation (association, not causation).",
    render() {
      setStep(
        "Experiment: tobacco availability vs asthma expenditure",
        `
        Workflow:
        <ol>
          <li>Define x: TobaccoAvailability</li>
          <li>Define y: AsthmaExpenditure_mean</li>
          <li>Plot one dot per MSOA</li>
          <li>Compute Pearson correlation (quick association measure)</li>
        </ol>
        <b>Important questions:</b>
        <ul>
          <li>Does correlation imply causation? (No.)</li>
          <li>Are outliers driving the result?</li>
          <li>What confounders might affect both?</li>
        </ul>
        `,
        warnBox(`Build the wide table first. Then click <b>Run correlation</b>. Try one city vs all cities.`)
      );
      showWideIfReady();
    }
  }
];

function setStep(title, bodyHtml, boxHtml) {
  el("stepTitle").textContent = title;
  el("stepBody").innerHTML = bodyHtml;
  el("stepBox").innerHTML = boxHtml || "";
}
function warnBox(html){ return `<div class="warn"><b>Try this:</b> ${html}</div>`; }
function okBox(html){ return `<div class="ok"><b>Good to know:</b> ${html}</div>`; }

/* ============================
   Data + analysis helpers
   ============================ */
function toNum(x) {
  const n = Number(String(x ?? "").trim());
  return Number.isFinite(n) ? n : NaN;
}
function mean(arr) {
  let s=0,c=0;
  for (const v of arr) if (Number.isFinite(v)) { s += v; c++; }
  return c ? s/c : NaN;
}
function pearson(xs, ys) {
  const pts = [];
  for (let i=0;i<xs.length;i++){
    const x=xs[i], y=ys[i];
    if (Number.isFinite(x) && Number.isFinite(y)) pts.push([x,y]);
  }
  const n = pts.length;
  if (n < 3) return { r: NaN, n };

  let sx=0, sy=0;
  for (const [x,y] of pts){ sx+=x; sy+=y; }
  const mx = sx/n, my = sy/n;

  let num=0, dx=0, dy=0;
  for (const [x,y] of pts){
    const vx = x-mx, vy=y-my;
    num += vx*vy;
    dx += vx*vx;
    dy += vy*vy;
  }
  const den = Math.sqrt(dx*dy);
  return { r: den ? num/den : NaN, n };
}

/* ============================
   Filtering (city + quick search)
   ============================ */
function getCity() {
  return el("citySelect").value;
}
function applyFilters(rows) {
  const city = getCity();
  const q = el("quickFilter").value.trim().toLowerCase();

  let out = rows;
  if (city !== "All cities") out = out.filter(r => r.CityName === city);

  if (q) {
    out = out.filter(r => Object.values(r).some(v => String(v ?? "").toLowerCase().includes(q)));
  }
  return out;
}

/* ============================
   Long/Wide table construction
   ============================ */
function buildWideTableFromLong(longRowsFiltered) {
  const byMSOA = new Map();

  function ensure(r) {
    if (!byMSOA.has(r.MSOACode)) byMSOA.set(r.MSOACode, {
      CityName: r.CityName,
      MSOAName: r.MSOAName,
      MSOACode: r.MSOACode,
      TobaccoAvailability: NaN,
      Walkability: NaN,
      AsthmaExpenditure_mean: NaN,
      Asthma_nMonths: 0,
      _asthma: [],
    });
    return byMSOA.get(r.MSOACode);
  }

  for (const r of longRowsFiltered) {
    if (!r.MSOACode) continue;
    const row = ensure(r);

    if (r.ThirdCategory === "TobaccoAvailability" && r.Time === "None") {
      const v = toNum(r.Value);
      if (Number.isFinite(v)) row.TobaccoAvailability = v;
    }
    if (r.ThirdCategory === "Walkability" && r.Time === "None") {
      const v = toNum(r.Value);
      if (Number.isFinite(v)) row.Walkability = v;
    }
    if (r.ThirdCategory === "AsthmaExpenditure") {
      const v = toNum(r.Value);
      if (Number.isFinite(v)) row._asthma.push(v);
    }
  }

  const out = [];
  for (const row of byMSOA.values()) {
    row.Asthma_nMonths = row._asthma.length;
    row.AsthmaExpenditure_mean = mean(row._asthma);
    delete row._asthma;
    out.push(row);
  }
  out.sort((a,b) => a.CityName.localeCompare(b.CityName) || a.MSOAName.localeCompare(b.MSOAName));
  return out;
}

/* ============================
   Handsontable rendering
   ============================ */
function ensureHot() {
  if (state.hot) return;

  const container = el("sheet");
  state.hot = new Handsontable(container, {
    data: [],
    colHeaders: [],
    columns: [],
    rowHeaders: true,
    height: "100%",
    stretchH: "all",
    manualColumnResize: true,
    manualRowResize: true,
    columnSorting: true,
    filters: true,
    dropdownMenu: true,
    licenseKey: "non-commercial-and-evaluation", // Handsontable CE/eval key for demos
  });
}

function setSheet(rows, columnsOrder) {
  ensureHot();

  state.currentRows = rows;
  state.currentColumns = columnsOrder;

  const dataMatrix = rows.map(r => columnsOrder.map(c => r[c]));
  const columnsSpec = columnsOrder.map(() => ({ readOnly: true }));

  state.hot.updateSettings({
    data: dataMatrix,
    colHeaders: columnsOrder,
    columns: columnsSpec
  });

  updateKPIs(rows);
}

function updateKPIs(rows) {
  el("kpiRows").textContent = rows.length.toLocaleString();
  const ms = new Set(rows.map(r => r.MSOACode).filter(Boolean));
  el("kpiGroups").textContent = ms.size ? ms.size.toLocaleString() : "—";

  if (state.view === "long") {
    const noneTime = rows.filter(r => String(r.Time).toLowerCase() === "none").length;
    el("kpiNote").textContent = `Long table check: rows with Time=None: ${noneTime.toLocaleString()}.`;
  } else {
    const missing = rows.filter(r =>
      !Number.isFinite(toNum(r.TobaccoAvailability)) || !Number.isFinite(toNum(r.AsthmaExpenditure_mean))
    ).length;
    el("kpiNote").textContent = `Wide table check: rows missing x or y for experiment: ${missing.toLocaleString()}.`;
  }
}

/* ============================
   Views
   ============================ */
const LONG_COLS = ["TopCategory","SecondCategory","ThirdCategory","CityName","MSOAName","MSOACode","Time","Key","Value"];
const WIDE_COLS = ["CityName","MSOAName","MSOACode","TobaccoAvailability","Walkability","AsthmaExpenditure_mean","Asthma_nMonths"];

function clearChart(msg) {
  Plotly.purge("chart");
  Plotly.newPlot("chart", [], { margin: {t: 20, r: 10, b: 40, l: 50} }, {displaylogo:false, responsive:true});
  el("chartCaption").textContent = msg;
}

function showLong() {
  state.view = "long";
  el("viewSelect").value = "long";
  el("gridCaption").textContent = "Long table view (raw measurements).";
  el("btnRunExp").disabled = true;

  const rows = applyFilters(state.longRows);
  setSheet(rows, LONG_COLS);
  clearChart("In long-table view. Build the wide table to run the experiment.");
}

function showWideIfReady() {
  if (!state.wideRows) {
    clearChart("Build the wide table first (click “Build wide table”).");
    return;
  }
  showWide();
}

function showWide() {
  state.view = "wide";
  el("viewSelect").value = "wide";
  el("gridCaption").textContent = "Wide table view (pivoted, analysis-ready).";
  el("btnRunExp").disabled = false;

  const rows = applyFilters(state.wideRows);
  setSheet(rows, WIDE_COLS);
  clearChart("Wide table ready. Click “Run correlation” to create a chart.");
}

/* ============================
   Experiment
   ============================ */
function runCorrelation() {
  if (!state.wideRows) return;

  const rows = applyFilters(state.wideRows);
  const xs = [], ys = [], labels = [];

  for (const r of rows) {
    const x = toNum(r.TobaccoAvailability);
    const y = toNum(r.AsthmaExpenditure_mean);
    if (Number.isFinite(x) && Number.isFinite(y)) {
      xs.push(x); ys.push(y);
      labels.push(`${r.CityName} — ${r.MSOAName} (${r.MSOACode})`);
    }
  }

  const { r, n } = pearson(xs, ys);

  const trace = {
    type: "scatter",
    mode: "markers",
    x: xs,
    y: ys,
    text: labels,
    hovertemplate: "%{text}<br><b>Tobacco</b>=%{x}<br><b>Asthma mean</b>=%{y}<extra></extra>",
    marker: { size: 9, opacity: 0.8 },
  };

  const layout = {
    title: {
      text: `Tobacco availability vs Asthma expenditure<br><span style="font-size:12px;color:#6b7280">Pearson r = ${Number.isFinite(r) ? r.toFixed(3) : "NA"} (n=${n})</span>`,
      x: 0, xanchor: "left"
    },
    margin: { t: 60, r: 10, b: 55, l: 70 },
    xaxis: { title: "TobaccoAvailability (example scale)", zeroline: false },
    yaxis: { title: "AsthmaExpenditure_mean (example £/citizen)", zeroline: false },
  };

  Plotly.react("chart", [trace], layout, { responsive:true, displaylogo:false });
  el("chartCaption").textContent =
    `One dot per MSOA. Pearson r summarizes association (not causation). r=${Number.isFinite(r) ? r.toFixed(3) : "NA"}, n=${n}.`;

  el("kpiNote").textContent =
    "Interpretation tip: check outliers, then ask what confounders (income, age, pollution) might explain both variables.";
}

/* ============================
   Step UI
   ============================ */
function renderSteps() {
  const wrap = el("steps");
  wrap.innerHTML = "";
  steps.forEach((s, i) => {
    const d = document.createElement("div");
    d.className = "step" + (i === state.stepIndex ? " active" : "");
    d.innerHTML = `<div class="t">${s.title}</div><div class="d">${s.desc}</div>`;
    d.onclick = () => { state.stepIndex = i; refreshStep(); };
    wrap.appendChild(d);
  });
}
function refreshStep() {
  renderSteps();
  steps[state.stepIndex].render();
  el("btnPrev").disabled = state.stepIndex === 0;
  el("btnNext").disabled = state.stepIndex === steps.length - 1;
}

/* ============================
   Boot
   ============================ */
window.addEventListener("DOMContentLoaded", () => {
  // Populate city dropdown
  const cities = ["All cities", ...Array.from(new Set(state.longRows.map(r => r.CityName))).sort()];
  const cs = el("citySelect");
  cities.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c;
    cs.appendChild(opt);
  });
  cs.value = "All cities";

  // Ensure chart placeholder
  clearChart("Follow the steps; charts appear when relevant.");

  // Init grid once
  ensureHot();

  // Wire UI
  el("quickFilter").addEventListener("input", () => {
    if (state.view === "long") showLong();
    else showWideIfReady();
  });

  el("citySelect").addEventListener("change", () => {
    if (state.view === "long") showLong();
    else showWideIfReady();
  });

  el("viewSelect").addEventListener("change", () => {
    const v = el("viewSelect").value;
    if (v === "long") showLong();
    else showWideIfReady();
  });

  el("btnReset").onclick = () => {
    el("quickFilter").value = "";
    cs.value = "All cities";
    if (state.view === "long") showLong();
    else showWideIfReady();
  };

  el("btnPivot").onclick = () => {
    // pivot from the CURRENT filtered long rows (so the user learns scope matters)
    const longFiltered = applyFilters(state.longRows);
    state.wideRows = buildWideTableFromLong(longFiltered);
    el("btnRunExp").disabled = false;
    showWideIfReady();
  };

  el("btnRunExp").onclick = () => runCorrelation();

  el("btnPrev").onclick = () => { state.stepIndex = Math.max(0, state.stepIndex - 1); refreshStep(); };
  el("btnNext").onclick = () => { state.stepIndex = Math.min(steps.length - 1, state.stepIndex + 1); refreshStep(); };

  // Initial
  showLong();
  refreshStep();
});
</script>
</body>
</html>
